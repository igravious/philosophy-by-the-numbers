
module Knowledge

	module Wikidata

		MAP_NAME = {
			'‘Abduh'                 => 'Abduh',
			'Abailard'               => 'Abelard',
			'Abu’l-Barakat al-Bahdadi' => "Abu'l-Barakāt al-Baghdādī",
			'Agrippa of Nettesheim'  => 'Heinrich Cornelius Agrippa',
			'Albert the Great'       => 'Albertus Magnus',
			'al-‘Amiri'              => 'al-Amiri',
			'al-Baghdadi'            => 'al-Baghdādī',
			'al Baghdadi'            => 'al-Baghdādī',
			'al-Dawani'              => 'Davani',
			'al Dawani'              => 'Davani',
			'al-Faràbi'              => 'Al-Farabi',
			'al Faràbi'              => 'Al-Farabi',
			'al-Fārābi'              => 'Al-Farabi',
			'al Fārābi'              => 'Al-Farabi',
		 	'al-Fārābī'              => 'Al-Farabi',
		 	'al Fārābī'              => 'Al-Farabi',
			'al-Ghazali'             => 'Ghazali',
			'al Ghazali'             => 'Ghazali',
			'al-Ghazàlì'             => 'Ghazali',
			'al Ghazàlì'             => 'Ghazali',
			'al-Ghazāli'             => 'Ghazali',
			'al Ghazāli'             => 'Ghazali',
	 		'al-Jabiri'              => 'al-Jabri', # (al-Jabiri, ʿAbd)
			'al-Muqammas'            => 'al-Mukkamas',
			'al Muqammas'            => 'al-Mukkamas',
			'Al-Mukamis'             => 'al-Mukkamas',
			'Al-Shahrastānī'         => 'Al-Shahrastani',
			'al-Sabzawari'           => 'Sabzavari',
			'al Sabziwari'           => 'Sabzavari',
			'al-Sijistani'           => 'Sijistani',
			'al Sijistani'           => 'Sijistani',
			'al-Suhrawardi'          => 'Suhrawardi',
			'al Suhrawardi'          => 'Suhrawardi',
			'al-Tawhidi'             => 'al-Tawhīdī',
			'al Tawhidi'             => 'al-Tawhīdī',
		 	"d'Alembert"             => "d'Alember", # (d'Alembert, Jean Le Rond)
			'Anaxagoras of Clazomenae' => 'Anaxagoras',
			'Anaxagoras of Klazomene'  => 'Anaxagoras',
			'Anaximander of Miletus'   => 'Anaximander',
			'Angélique Arnauld'      => 'Marie Angélique Arnauld',
			'Antisthenes Of Athens'  => 'Antisthenes',
			'Arcesilaus of Pitane'   => 'Arcesilaus',
			'Ardigo'                 => 'Ardigò',
			'Aristippus the Elder'   => 'Aristippus',
			'Aristippus of Cyrene'   => 'Aristippus',
			'Ariston of Chios'       => 'Aristo of Chios',
			'Aureol'                 => 'Aureolus', # (Aureol, Peter)
			'Avicehron'              => 'Solomon ibn Gabirol',
			'Bar Hayya'              => 'bar Hiyya',
			# 'Bartolus of Sassoferrato' => 'Bartolus de Saxoferrato',
			'Bernard of Tours'       => 'Bernard Silvestris',
			# 'Bhartṛhari' => 'Bhartṛhari',
			'Boehme'                 => 'Böhme',
			'Boethius of Dacia'      => 'Boetius of Dacia',
			'Buddhagosa'             => 'Buddhaghosa',
			'Cajetan (Thomas de Vio)'=> 'Thomas Cajetan',
			'Chaadaev'               => 'Chaadayev',
			"Chang Heng-ch'u"        => 'Zhang Zai',
			"Chang Hsüeh-ch'eng"     => 'Zhang Xuecheng',
			"Ch'eng Hao"             => 'Cheng Hao',
			"Ch'eng Yi"              => 'Cheng Yi',
			'Chernyshevskii'         => 'Chernyshevsky',
			'Chernyshevski'          => 'Chernyshevsky',
			'Chia Yi'                => 'Jia Yi',
			'Chou Tun-yi'            => 'Zhou Dunyi',
			'Chou Tun-i'             => 'Zhou Dunyi',
			'Chông Yagyong (Tasan)'  => 'Jeong Yak-yong',
			'D’Andilly'              => "D'Andilly",
			'David the Invincible'   => 'David Anhaght',
			'Denys the Carthusian'   => 'Denis the Carthusian',
			'Democritus of Abdera'   => 'Democritus',
			'Dietrich of Freiberg'   => 'Theodoric of Freiberg',
			'Diogenes Laertius'      => 'Diogenes Laërtius',
			'Dionysius the Pseudo-Areopagite' => 'Pseudo-Dionysius the Areopagite',
			'Dodgson'                => 'Lewis Carroll',
			'Dostoevskii'            => 'Dostoyevsky',
			'Dostoevsky'             => 'Dostoyevsky',
			'Du Châtelet-Lomont'     => 'Émilie du Châtelet',
			'Durandus of St Pourçain'=> 'Durandus of Saint-Pourçain',
			'Elisabeth of Bohemia'   => 'Elisabeth of the Palatinate',
			'Elizabeth of Bohemia'   => 'Elisabeth of the Palatinate',
			'Empedocles of Acragas'  => 'Empedocles',
			'Empedocles Of Agrigentum,' => 'Empedocles',
			'Florenskii'             => 'Florensky',
	 		'Florovskii'             => 'Florovsky',
			'Francis of Meyronnes'   => 'Francis of Mayrone',
	 		'Françoise d’Aubigné'    => "Francoise d'Aubigne",
			'Fung Yu-lan'            => 'Feng Youlan',
			'Galen of Pergamum'      => 'Galen',
			'Gaṅgeśa'                => 'Gangesha',
			'Gangesa'                => 'Gangesha',
			'Gilbert of Poitiers'    => 'Gilbert de la Porrée',
			'Gorgias of Leontini'    => 'Gorgias',
			'Haeberlin'              => 'Häberlin',
			'Han Fei Tzu'            => 'Han Fei',
			'Han Yü'                 => 'Han Yu',
			'Henry of Harclay'       => 'Henry Harclay',
			# 'Hoernlé' => 'Hoernle',
			'Heraclitus of Ephesus'  => 'Heraclitus',
			'Heraclides of Pontus'   => 'Heraclides Ponticus',
			'Hillel of Verona'       => 'Hillel ben Samuel',
			#'Hillel ben Samuel of Verona' => 'Hillel ben Samuel',
			'Hippasus'               => 'Hipasus',
			'Ho Yen'                 => 'He Yan',
			'Hsiung Shih-li'         => 'Xiong Shili',
			'Hsu Fu-kuan'            => 'Xu Fuguan',
			'Hsun Tzu'               => 'Xunzi',
			'Hsün Tzu'               => 'Xunzi',
			'Huang Tsung-hsi'        => 'Huang Zongxi',
			"Hsi K'ang"              => 'Ji Kang',
			'Hsu Hsing'              => 'Xu Xing',
			'Hugh of St Victor'      => 'Hugh of Saint Victor',
			'Hugo of St. Victor'     => 'Hugh of Saint Victor',
			'Hui Shih'               => 'Hui Shi',
			'Ibn ‘Adi'               => 'ibn Adi',
			'Ibn al-‘Arabi'          => 'Ibn ul-Arabi',
			'Ibn ar-Rawandi'         => 'Ibn al-Rawandi',
			'Ibn Bâjja'              => 'Avempace',
		 	'Ibn Al-ʿArabī'          => 'Ibn ul-Arabi',
 			'Ibn Ṭufayl'             => 'Ibn Tufail',
			'Ibn Sab‘in'             => "Ibn Sab'in",
			'Il’enkov'               => 'Ilyenkov',
			'Il’in'                  => 'Ilyin',
			# 'Immanuel ben Solomon of Rome' => 'Immanuel the Roman',
			'Jamblicus'              => 'Iamblichus',
			'Jeanne-Françoise Frémyot' => 'Jane Frances de Chantal',
			'John of St Thomas'      => 'John of St. Thomas',
			'Johannes Philoponus'    => 'John Philoponus',
			'Juan Chi'               => 'Ruan Ji',
			"K'ang Yu-wei"           => 'Kang Youwei',
			'Kao Tzu'                => 'Gaozi',
			'Kauṭilya'               => 'Chanakya',
			'Kireevskii'             => 'Kireyevsky',
			'Ko Hung'                => 'Ge Hong',
			'Kuan Tzu'               => 'Guan Zhong',
			'Kuan Chung'             => 'Guan Zhong',
			'Kung-sun Lung Tzu'      => 'Gongsun Long',
			'Kuo Hsiang'             => 'Guo Xiang',
			'Kûkai'                  => 'Kūkai',
			# 'Judah ben Moses of Rome' => 'Judah ben Moses Romano',
			'Le Doeuff'              => 'Le Dœuff',
			'Leont’ev'               => 'Leontiev',
			'Lesniewski'             => 'Leśniewski',
			'Leucippus of Miletus'   => 'Leucippus',
			'Levy-Bruhl'             => 'Lévy-Bruhl',
			"Liang Ch'i-ch'ao"       => 'Liang Qichao',
			'Liang Sou-ming'         => 'Liang Shuming',
			'Lieh Tzu'               => 'Lie Yukou',
			"Liu Shao-ch'i"          => 'Liu Shaoqi',
			'Lu Hsiang-shan'         => 'Lu Jiuyuan',
			#'Abraham ben Moses Maimonides' => 'Abraham ben Moses ben Maimon',
			'Mahāvirā'               => 'Mahavira',
			'Mādhava'                => 'Vidyaranya',
			'Mikhailovskii'          => 'Mikhaylovsky',
			'Minucius Felix'         => 'Marcus Minucius Felix',
			#'Mulla Sadra (Sadr al-Din Muhammad al-Shirazi)'    => 'Mulla Sadra',
			#'Novalis (Georg Philipp Friedrich von Hardenberg)' => 'Novalis',
			'Mullā Ṣadrā'            => 'Mulla Sadra',
			'Mou Tsung-san'          => 'Mou Zongsan',
		 	'Nakae Toju'             => 'Toju Nakae',
			'Nāṣir Khosrow'          => 'Nasir Khusraw',
			'Nemesius of Emesa'      => 'Nemesius',
			'Olympiodorus of Alexandria' => 'Olympiodorus the Younger',
			'Origen of Alexandria'   => 'Origen',
			'Panaetius of Rhodes'    => 'Panaetius',
			'Parmenides of Elea'     => 'Parmenides',
			'Patocka'                => 'Patočka',
			'Pecham'                 => 'Peckham',
 			'Petroniević'            => 'Petronijević',
			'Philo of Alexandria'    => 'Philo',
			'Philodemus of Gadara'   => 'Philodemus',
			'Philolaus of Croton'    => 'Philolaus',
			'Posidonius of Apamea'   => 'Posidonius',
			'Posidonius of Rhodes'   => 'Posidonius',
			'Poulain de la Barre'    => 'Poullain de la Barre',
			'Protagoras of Abdera'   => 'Protagoras',
			'Pyrrho of Elis'         => 'Pyrrho',
			#'Plutarch of Chaeronea'  => 'Plutarch',
			#'Pseudo-Grosseteste'     => 'Grosseteste',
			'Richard of St Victor'   => 'Richard of Saint Victor',
			'Richard the Sophister'  => 'Richard Rufus of Cornwall',
			'Roscelin of Compiègne'  => 'Roscellinus',
			'Saadiah Gaon'           => 'Saadia Gaon',
			'Saadia ben Joseph'      => 'Saadia Gaon',
			'Saint Augustine'        => 'Augustine of Hippo',
			'Shah Wali Allah'        => 'Shah Waliullah',
			'Shaṅkara'               => 'Shankara',
			"Shao K'ang-chieh"       => 'Shao Yong',
			'Shao Yung'              => 'Shao Yong',
			'Shen Pu-hai'            => 'Shen Buhai',
			'Shen Tao'               => 'Shen Dao',
			'Sherwood'               => 'William of Sherwood',
			'Solov’ëv'               => 'Solovyov',
			'Sôsan Hyujông'          => 'Hyujeong',
			'Staël-Holstein'         => 'de Staël',
			'Suhrawardī'             => 'Suhrawardi',
 			'Sylvester of Ferrara'   => 'Francesco Silvestri',
			"Solov'ëv"               => 'Solovyov',
			'Tai Chen'               => 'Dai Zhen',
			'Tai Tung-yuan'          => 'Dai Zhen',
			"T'an Ssu-t'ung"         => 'Tan Sitong',
			'Thales of Miletus'      => 'Thales',
			'Toletus'                => 'Toledo',
			'Tung Chung-shu'         => 'Dong Zhongshu',
			'Turro y Darder'         => 'Turró i Darder',
			'Umar Khayyam'           => 'Omar Khayyám',
			'Ûisang'                 => 'Uisang',
			'Vallabhācārya'          => 'Vallabha',
			'Veṅkaṭanātha'           => 'Vedanta Desika',
			'Vygotskii'              => 'Vygotsky',
			'Wang Chung'             => 'Wang Chong',
			"Wang Ch'ung"            => 'Wang Chong',
			'Wang Fu-chih'           => 'Wang Fuzhi',
			'Wang Pi'                => 'Wang Bi',
			'Wang Yang-Ming'         => 'Wang Yangming',
			'Wang Yang-ming'         => 'Wang Yangming',
			'Wônch’ūk'               => 'Woncheuk',
			'Wônhyo'                 => 'Wonhyo',
			'Xenophanes of Colophon' => 'Xenophanes',
			'Yang Hsiung'            => 'Yang Xiong',
			'Yang Chu'               => 'Yang Zhu',
			'Yangzhu'                => 'Yang Zhu',
			'Yen Yüan'               => 'Yan Yuan',
			'Yi Yulgok'              => 'Yi I',
			'Zeno the Stoic'         => 'Zeno of Citium',
			'Chu Hsi'                => 'Zhu Xi',
			'Zizek'                  => 'Žižek',
			"Zor’kin"                => 'Zorkin'
		}

		MULTIPLE = {
		}

		BOUND_URI = 's'.freeze
		BOUND_LABEL = 'sLabel'.freeze
		BOUND_PROP = 'p'.freeze
		BOUND_VALUE = 'v'.freeze

		LABEL_TO_ENTITIES = "
		PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		SELECT ?#{BOUND_URI} WHERE {
			?#{BOUND_URI} rdfs:label '%{interpolated_label}'@en .
		}
		".freeze

		ENGLISH_LABEL = "
		PREFIX wd: <http://www.wikidata.org/entity/>
		SELECT ?#{BOUND_VALUE} WHERE {
			wd:%{interpolated_entity} rdfs:label ?#{BOUND_VALUE} FILTER (lang(?#{BOUND_VALUE}) = 'en') .
		}
		".freeze

		ENGLISH_VALUES = "
		PREFIX wd: <http://www.wikidata.org/entity/>
		SELECT ?#{BOUND_PROP} ?#{BOUND_VALUE} WHERE {
			wd:%{interpolated_entity} ?#{BOUND_PROP} ?#{BOUND_VALUE} FILTER (lang(?#{BOUND_VALUE}) = 'en') .
		}
		".freeze

		# {'A' => 'P31', 'B' => 'P279', 'C' => 'P361'}.each {|k,v| Object.const_set(k, "hello #{v}")}
		# this is why I ♥  Ruby
		{'INSTANCE_OF' => 'P31', 'SUBCLASS_OF' => 'P279', 'PART_OF' => 'P361'}.each {|konst,meros| Object.const_set(konst, "
		# P31=instance of, P279=subclass of, P361=part of
		# too much magic here
		SELECT (wd:%{interpolated_entity} as ?x) (p:#{meros} as ?y) ?#{BOUND_URI} ?#{BOUND_LABEL} WHERE {
			wd:%{interpolated_entity} p:#{meros} ?cn_stmt .
			?cn_stmt ps:#{meros} ?#{BOUND_URI} .
			SERVICE wikibase:label {
				bd:serviceParam wikibase:language 'en' .
			}
		}
		")}

		# {"Q3190382"=>"justice"} : subcategory of welfare economics
		# {"Q6316856"=>"justice"} : concept in research ethics concerning the fair selection of research participants
		# {"Q1078867"=>"nature"} : philosophical concept
		# {"Q21263961"=>"nature"} : character
		AVOIDED_ENTITIES = ["Q3190382", "Q6316856", "Q1078867", "Q21263961"]

		class Client

			def reset
				@entities = AVOIDED_ENTITIES.dup
				@meros = RDF::Graph.new
				# @labels = RDF::Graph.new
				@labels = Hash.new
			end

			def initialize(accumulate=false)
				require 'sparql/client'
				@sparql = SPARQL::Client.new('https://query.wikidata.org/sparql', method: :get)
				@accumulate = accumulate
			end

			def recurse_query(label)
				the_grep_meister(label)
			end

			def query(q)
				res =  @sparql.query(q)
			end

			# private methods

			def meros(konst_str, n, entity)
				query = Object.const_get(konst_str) % {interpolated_entity: entity}
				res =  @sparql.query(query)
				property = res.first
				if !property.nil?
					m = res.length
					if res.length > 1
						STDOUT.printf "## "
						res.each {|r| STDOUT.printf(" #{(r.bindings[BOUND_LABEL.to_sym]).to_s.split('/').last}")}
						STDOUT.printf "\n"
					end
					new_entity_uri = property.bindings[BOUND_URI.to_sym]
					new_entity_str = new_entity_uri.to_s.split('/').last
					label_uri = property.bindings[BOUND_LABEL.to_sym]
					label = label_uri.to_s.split('/').last
					a = [property.bindings[:x], property.bindings[:y], new_entity_uri]
					@meros << a
					out = "#{entity} #{konst_str.downcase!} #{{new_entity_str => label}}"
					if @entities.include? new_entity_str
						STDOUT.puts ">> #{out}"
						return nil
					else
						# l = [new_entity_uri, RDF::RDFS.label, label]
						# @labels << l
						@labels[new_entity_str] = label
						@entities.push(new_entity_str)
						STDOUT.printf("%02d #{out}\n",n)
						return {new_entity_str => label}
					end
				else
					return nil
				end
			end

			def part_of(n, entity)
				meros('PART_OF', n, entity)
			end

			def subclass_of(n, entity)
				meros('SUBCLASS_OF', n, entity)
			end

			def instance_of(n, entity)
				meros('INSTANCE_OF', n, entity)
			end

			# WHERE THE FUCK DID THE REST OF IT GO?

			def recurse_grep(n, pair)
				# puts "#{n} #{pair}"
				if !pair.nil?
					entity,label = pair.first # {} -> [] -> _,_
					# puts "entity #{entity} : #{label}"
					# p = (n+1)*2
					if !recurse_grep(n+1, part_of(n, entity))
						if !recurse_grep(n+1, subclass_of(n, entity))
							recurse_grep(n+1, instance_of(n, entity))
						end
					end
				else
					return false
				end
				return true
			end

			def description(entity)
				# "G%{a}GLE" % {:a => 'OO'}
				query = ENGLISH_VALUES % {interpolated_entity: entity}
				properties = @sparql.query(query)
				# an array of rdf query solutions
				# [#<RDF::Query::Solution:0x35bd440({:prop=>#<RDF::URI:0x3635788 URI:http://schema.org/description>, :value=>#<RDF::Literal:0x35bd4f4("phenomena of the physical world, and also to life in general"@en)>})>, #<RDF::Query::Solution:0x35bd06c({:prop=>#<RDF::URI:0x35bd350 URI:http://www.w3.org/2000/01/rdf-schema#label>, :value=>#<RDF::Literal:0x35bd120("nature"@en)>})>]
				properties.each do |q_sol2|
					prop_uri = q_sol2.bindings[BOUND_PROP.to_sym]
					if 'http://schema.org/description' == prop_uri.to_s or 'http://www.w3.org/2004/02/skos/core#altLabel' == prop_uri.to_s
						prop_value = q_sol2.bindings[BOUND_VALUE.to_sym]
						return prop_value.to_s
					end
				end
				return ''
			end

			def label_to_entities(label)
				query = LABEL_TO_ENTITIES % {interpolated_label: label}
				@sparql.query(query)			
			end

			def the_grep_meister(label)
				result_set = label_to_entities(label)
				# p result_set
				reset if !@accumulate
				result_set.each do |q_sol1|
					entity_uri = q_sol1.bindings[BOUND_URI.to_sym]
					# puts entity_uri.to_s
					entity_str = entity_uri.to_s.split('/').last
					h = {entity_str => label}
					desc = description(entity_str)
					out = "#{h} : #{desc}"
					if @entities.include? entity_str
						STDOUT.puts "-- #{out}"
						next
					end
					@entities.push(entity_str)
					# puts entity_str
					# l = [entity_uri, RDF::RDFS.label, label]
					# @labels << l
					@labels[entity_str] = label
					puts "++ #{out}"
					recurse_grep(0, h)
				end
				[@meros, @labels]
			end

			private :the_grep_meister, :recurse_grep, :description, :instance_of, :subclass_of, :part_of, :meros

		end

		module API

			SITELINKS='sitelinks'
			WIKI='enwiki'

			# this should be in knowledge.rb and it should be cached
			def self.wiki_title(entity)
				# https://www.wikidata.org/w/api.php?action=wbgetentities&format=xml&props=sitelinks&ids=Q868&sitefilter=enwiki
				service_url = 'https://www.wikidata.org/w/api.php'
				http_params = {action: 'wbgetentities', format: 'json', props: SITELINKS, ids: entity} #, sitefilter: WIKI}
				url = service_url + '?' + http_params.to_query
				require 'open-uri'
				json_resp = open(url)
				if json_resp.status[0] == '200'
					resp = JSON.parse json_resp.read
					if resp['success'] == 1
						begin
							title = ""
							title = resp['entities'][entity][SITELINKS][WIKI]['title']
							site = WIKI
						rescue
							begin
								site = ""
								title = resp['entities'][entity][SITELINKS].first[1]['title']
								site = resp['entities'][entity][SITELINKS].first[1]['site']
							rescue
								STDERR.puts resp
							end
						end
					else
						raise "Wikidata API query unsuccessful #{resp['error']}"
					end
				else
					raise "Wikidata API query HTTP status #{json_resp.status}"
				end
				return [site, title]
			end

		end

	end # module Wikidata

end # module Knowledge
