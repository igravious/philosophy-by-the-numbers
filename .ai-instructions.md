# Analysis of the CorpusBuilder Project

This document provides an analysis of the CorpusBuilder Ruby on Rails project.

## AI Assistant Instructions

### Communication with User

Always keep the user informed of actions taken, such as running terminal commands, editing files, or performing analyses. Provide clear explanations of what you're doing and why.

### Command Execution Preferences

**Always prefer the `bin/` versions of commands in this Rails project:**

- Use `bin/rake` instead of `rake` or `bundle exec rake`
- Use `bin/rails` instead of `rails` or `bundle exec rails`
- This avoids Ruby version conflicts and gem version mismatches
- The bin/ directory contains binstubs that handle proper bundler context automatically

Example commands:
```bash
# Preferred
bin/rake -T
bin/rake shadow:philosopher:populate
bin/rails console
bin/rails server

# Avoid
rake -T
bundle exec rake -T
rails console
```

### Testing Commands (Rails 4.2)

**Always use the correct Rails 4.2 test syntax:**

```bash
# Correct Rails 4.2 test syntax
bin/rake test TEST=test/controllers/questions_controller_test.rb TESTOPTS="-v"
bin/rake test TEST=test/models/philosopher_test.rb
bin/rake test

# Avoid (Rails 5+ syntax that doesn't work in Rails 4.2)
bin/rails test test/controllers/questions_controller_test.rb
rails test
```

### Ruby 2.6.10 + Rails 4.2 Threading Issues

**IMPORTANT:** This project uses Ruby 2.6.10 with Rails 4.2.11.3, which has a known Monitor threading incompatibility that causes `ThreadError: already initialized` in ActionController::TestCase.

**Resolution Status:** ✅ **RESOLVED** - Automatic workaround implemented

**Workaround Files:**
- `config/initializers/ruby_2_6_monitor_fix.rb` - Monitor class monkey patch
- `test/support/thread_error_workarounds.rb` - Alternative testing methods

**What was implemented:**
- Monitor reinitialization protection to prevent ThreadError
- Alternative `safe_controller_get()` method for testing controllers
- Automatic fallback Response creation that bypasses Monitor issues

**Result:** All tests now pass without ThreadError. No manual intervention needed.

**Note:** This project uses Ruby 2.6.10 with specific gem versions. The bin/ directory binstubs handle bundler context properly to avoid "already activated" gem version errors.

## Project Overview

CorpusBuilder is a Ruby on Rails application designed for building and managing a corpus of philosophical texts. It features a rich data model, a powerful querying interface, and integration with Semantic Web and Linked Data sources.

## Development Environment

### Ruby Version Management
- **rbenv** - Installed via Homebrew for managing Ruby versions
- **Current Ruby version:** 2.6.10
- **Bundler version:** 1.17.3 (patched to support `bundle list --name-only`)

### Bundler Patch
Bundler 1.17.3 has been patched to enable the `list_command` feature flag:
- **File:** `/home/groobiest/.rbenv/versions/2.6.10/lib/ruby/gems/2.6.0/gems/bundler-1.17.3/lib/bundler/feature_flag.rb`
- **Change:** `settings_flag(:list_command) { true }` (enables `bundle list --name-only` support)

## Key Technologies & Software Versions

### Core Framework & Database
*   **Ruby on Rails 4.2.11.3** - Web application framework for Ruby, providing MVC architecture and conventions for rapid development
*   **composite_primary_keys 8.1.8** - Enables ActiveRecord models to use composite primary keys (multiple columns as primary key)
*   **SQLite3 ~1.3.0** - Lightweight, serverless SQL database engine used for data storage

### Frontend & UI Technologies
*   **jquery-rails 4.4.0** - Integrates jQuery JavaScript library with Rails asset pipeline for DOM manipulation and AJAX
*   **sass-rails ~5** - Integrates Sass CSS preprocessor with Rails, enabling variables, nesting, and mixins in stylesheets
*   **cocoon 1.2.15** - Rails gem for handling dynamic nested forms with add/remove functionality
*   **font-awesome-rails 4.7.0.7** - Provides Font Awesome icon fonts for Rails applications
*   **kaminari** - Pagination library for ActiveRecord collections and arrays
*   **jbuilder 2.9.1** - Template engine for building JSON APIs with Rails

### HTTP & Web Processing
*   **httparty 0.18.1** - Ruby HTTP client library with a simple, chainable API for making HTTP requests
*   **faraday 1.4.1** - HTTP client library with middleware support for customizable request/response processing
*   **nokogiri ~1.9** - Ruby HTML, XML, SAX, and Reader parser with XPath and CSS selector support

### Search & Data Processing
*   **elasticsearch 7.12.0** - Distributed search and analytics engine for full-text search and data analysis
*   **watir ~6.0** - Web application testing framework that drives browsers for automated web scraping
*   **headless 2.3.1** - Provides headless display server (Xvfb) for running GUI applications without a display

### Semantic Web & Linked Data
*   **json-ld** - JavaScript Object Notation for Linked Data, providing structured data representation
*   **rdf-turtle** - Parser and serializer for RDF Turtle format (Terse RDF Triple Language)
*   **rdf-raptor** - Ruby bindings for Raptor RDF syntax library
*   **sparql-client** - SPARQL client for querying RDF data stores and endpoints
*   **ebnf 2.1.3** - Extended Backus–Naur Form parser generator for parsing structured data

### Image & File Processing
*   **rmagick ~4** - Ruby bindings for ImageMagick image manipulation library
*   **rouge** - Pure Ruby syntax highlighter compatible with Pygments themes

### Caching & Performance
*   **moneta** - Unified interface for key/value stores (Redis, Memcached, etc.)
*   **dalli 2.7.11** - High-performance pure Ruby client for Memcached
*   **api_cache 0.3.0** - Caching layer for API responses with configurable backends

### Development & Debugging Tools
*   **pry** - Interactive Ruby REPL and debugger with advanced introspection capabilities
*   **web-console** - Rails debugging tool providing interactive console in error pages
*   **ffi-hunspell 0.6.1** - Ruby bindings for Hunspell spell checker
*   **ruby-prof** - Fast code profiler for Ruby applications
*   **progress_bar** - Simple progress bar library for command-line operations

### Version Control & Project Management
*   **git ~1.7** - Ruby interface to Git version control system
*   **thor** - Toolkit for building powerful command-line interfaces

## Application Architecture

### Data Model

The application's data model is complex and centered around a `shadows` table that uses Single Table Inheritance (STI) to store information about both philosophers and works. This table is very wide and contains a wealth of metadata from various sources, including DBpedia, VIAF, and several online encyclopedias.

Other key tables include:

*   `texts`: Represents the actual texts in the corpus.
*   `authors`: Represents the authors of the texts.
*   `dictionaries` and `units`: For lexical analysis of the texts.
*   `tags`, `labelings`, `filters`, `meta_filters`: A flexible system for classifying and organizing the texts.
*   `fyles`: Stores metadata about the files on disk.
*   `links`, `properties`, `p_smarts`: Tables for integrating with Semantic Web and Linked Data sources.

### Data Model Details

**Single Table Inheritance (STI) - The Shadow Model:**
- **Base class**: `Shadow` (in `shadows` table with 100+ columns)
- **Subclasses**: `Philosopher` and `Work`
- Contains metadata from DBpedia, VIAF, Wikidata, and multiple encyclopedias
- Key methods: `#english`, `#year`, `#show_label` for multi-language support

**Core Model Relationships:**
- `Philosopher` (Shadow subclass) → has_many `Work` (Shadow subclass)
- `Work` → has_many `Text` (actual corpus content)
- `Shadow` → has_many `Name` (multi-language labels)
- `Text` → belongs_to `Author` (distinct from Philosopher)
- `Fyle` → file metadata with caching system for corpus documents

**Classification & Metadata:**
- `Tag`, `Labeling`, `Filter`, `MetaFilter` → flexible tagging system
- `CanonicityWeights` → configurable algorithm weights (no hardcoded values)
- `MetricSnapshot` → complete audit trail for all metric calculations

**Semantic Web Integration:**
- `Link`, `Property`, `P::Smart` → RDF/Linked Data connections
- SPARQL client integration for Wikidata and DBpedia queries

**Key Modules:**
- `DateTimeMethods` (concern) → date parsing utilities
- `SecurityConfig` (`app/lib/security_config.rb`) → centralized security validation
- `Philosoraptor` module → external API integration

### Routes

The application's routes are a mix of standard RESTful resources and custom routes for specific pages and actions. The routes reveal a sophisticated interface for querying the corpus, with dedicated pages for asking questions about various aspects of the data.

## Key Features

*   **Corpus Management:** The application provides a comprehensive set of tools for managing a corpus of philosophical texts, including adding, editing, and deleting philosophers, works, texts, and authors.
*   **Data Integration:** The application integrates with external data sources like DBpedia and VIAF to enrich the corpus with additional metadata.
*   **Semantic Web/Linked Data:** The application uses Semantic Web technologies to represent and query the data.
*   **Powerful Querying:** The application provides a sophisticated interface for querying the corpus, allowing users to ask complex questions about the data.
*   **File Management:** The application has a robust system for managing the files that make up the corpus, including caching, versioning, and health checking.

## Considerations

*   **Rails Version:** The application is built on Rails 4.2.
*   **Frontend:** The application uses Bower for frontend package management.
*   **Complex Schema:** The database schema is complex and, in some cases, unconventional. This could make it difficult for new developers to understand and work with the application.

## Development Commands

### Starting the Rails Server
To start the Rails development server, use:
```bash
bin/bundle exec rails server
```

This ensures the application runs with the correct gem dependencies managed by Bundler.

### Common Development Tasks

```bash
# Database operations
bin/rake db:migrate               # Run pending migrations
bin/rake db:schema:dump           # Update schema.rb after migrations
bin/rake db:seed                  # Load seed data

# Testing
bin/rake test                     # Run all tests
bin/rake test TEST=test/models/philosopher_test.rb              # Run single test file
bin/rake test TEST=test/controllers/questions_controller_test.rb TESTOPTS="-v"  # Run with verbose output

# Asset management (Bower + Rails Pipeline)
bower install                     # Install frontend dependencies from bower.json
bin/rake resolve:paths            # Fix relative path issues in bower CSS files
bin/rake assets:precompile        # Compile assets for production
bin/rake assets:clobber           # Remove all compiled assets

# Linting & Code Quality
bin/standardrb                    # Run StandardRB linter (Ruby style checker)

# Key rake tasks (see bin/rake -T for all 100+ tasks)
bin/rake shadow:philosopher:populate           # Populate philosophers from Wikidata SPARQL
bin/rake shadow:philosopher:metric             # Calculate canonicity measures for all philosophers
bin/rake shadow:philosopher:danker             # Import danker PageRank scores
bin/rake shadow:work:populate                  # Populate philosophical works from Wikidata
bin/rake corpus:ES_MAKE_SNAPSHOT[url,year]     # Create Elasticsearch corpus snapshot
bin/rake corpus:GIT_STATUS                     # Show version control status of corpus files
bin/rake delta_analysis:process_works          # Run delta-of-deltas convergence analysis
bin/rake snarf:sep                             # Scrape Stanford Encyclopedia of Philosophy
bin/rake snarf:iep                             # Scrape Internet Encyclopedia of Philosophy
```

### Testing Philosophy
This project follows **Test-Driven Development (TDD)**. Always add tests first before implementing new features or making changes. This ensures code quality and prevents regressions when modifying complex systems like the canonicity metrics calculation.

### Coding Philosophy
Follow the **DRY (Don't Repeat Yourself)** principle. When you find yourself writing similar code in multiple places, refactor it into a shared module, method, or configuration file. Examples in this codebase:
- Warning suppression logic centralized in `config/suppress_warnings.rb` and used by all bin scripts
- Canonicity calculation logic extracted into `Philosopher#calculate_canonicity_measure` method
- Shared progress bar and error handling patterns in rake tasks

### Canonicity Algorithm Implementation
**Status**: ✅ COMPLETE

- **Algorithm**: Linear Weighted Combination with normalized importance weights
- **Configuration**: Stored in `canonicity_weights` table (no hardcoded constants)
- **Auditing**: Each `MetricSnapshot` records exact weights configuration used
- **Rake Tasks**: Refactored to use database configuration and write to snapshots (not override records)
- **Testing**: Comprehensive test suite with isolated approach (avoids 13K+ record iteration)
- **Documentation**: Complete documentation in `/docs/` directory

### Security Implementation
**Status**: ✅ COMPLETE - All vulnerabilities fixed and tested

**Security Fixes Implemented:**
- **SQL Injection**: Method whitelisting in QuestionsController#specific
- **Code Injection**: SecurityConfig validation for dynamic method calls
- **Path Traversal**: File ID validation in DictionariesController  
- **Hardcoded Credentials**: Environment variables in Philosoraptor module
- **Exception Handling**: Specific exception types with proper logging

**Security Infrastructure:**
- **SecurityConfig Module** (`app/lib/security_config.rb`) - Centralized security validation
- **Environment Template** (`.env.template`) - Secure credential configuration
- **Core Extensions** (`config/initializers/core_extensions.rb`) - Proper loading order

**Testing:** 21 security assertions - ALL PASSING with isolation testing approach

### Delta-of-Deltas Text Convergence Analysis

**Purpose**: Detect convergence patterns in philosophical texts by analyzing how text similarities evolve as the corpus grows.

**Status**: ✅ COMPLETE - Implemented with Saffron-OS integration

**Three-Phase Pipeline:**

**Phase 1: Progressive Corpus Runs** (`delta_phases:saffron_runs`)
- Generates progressively larger corpus snapshots
- Creates Saffron-OS analysis for each snapshot size
- Supports canonicity-based work selection
- Output: `delta_of_deltas/{base_dir}/saffron_run_{n}/`

**Phase 2: Delta Calculation** (`delta_phases:calculate_deltas`)
- Compares adjacent Saffron results to compute deltas
- Supports multiple diff strategies (euclidean, cosine, manhattan, etc.)
- Output: `delta_of_deltas/{base_dir}/deltas/`

**Phase 3: Delta-of-Deltas** (`delta_phases:delta_of_deltas`)
- Analyzes how deltas change over corpus size
- Detects convergence when delta-of-deltas falls below threshold
- Output: `delta_of_deltas/{base_dir}/delta_of_deltas/`

**Quick Start:**
```bash
# Run complete analysis on high-canonicity works
bin/rake delta_analysis:process_works

# Or run phases individually
bin/rake delta_phases:saffron_runs[10,0.5,my_analysis]
bin/rake delta_phases:calculate_deltas[my_analysis,euclidean]
bin/rake delta_phases:delta_of_deltas[my_analysis,0.1]
```

**Documentation**: See `docs/DELTA_OF_DELTAS_ALGORITHM.md` for complete mathematical and implementation details.

### Documentation Structure
- **`docs/CANONICITY_ALGORITHM.md`**: Complete algorithm documentation and mathematical formulas
- **`docs/RAKE_TASKS.md`**: Comprehensive rake task documentation with usage examples
- **`docs/TESTING_STRATEGY.md`**: Detailed testing approach for legacy Rails apps with large datasets
- **`docs/DELTA_OF_DELTAS_ALGORITHM.md`**: Delta-of-deltas convergence analysis mathematical specifications
- **`SECURITY_FIXES.md`**: Comprehensive security vulnerability fixes documentation
- **`THREADERROR_INVESTIGATION.md`**: Complete ThreadError root cause analysis

### Rake Task Organization

The application provides 100+ rake tasks organized into 15 task files in `lib/tasks/`. Use `bin/rake -T` to see all available tasks.

**Key Task Categories:**

**Data Population & Integration:**
- `shadow:philosopher:*` - Wikidata philosopher population, metrics calculation, enrichment
- `shadow:work:*` - Philosophical work population and metadata
- `shadow:property:*` - Wikidata property investigations
- `danker:*` - PageRank data management and updates

**Corpus Management:**
- `corpus:ES_*` - Elasticsearch indexing, snapshots, and search
- `corpus:GIT_*` - Git-based version control for corpus files
- `downloaded:*` - Manage cached downloaded texts
- `sources:*` - Report on different text sources

**Encyclopedia Scraping (`snarf:*`):**
- Stanford Encyclopedia of Philosophy (SEP)
- Internet Encyclopedia of Philosophy (IEP)
- Routledge Encyclopedia of Philosophy (REP)
- Oxford Dictionary of Philosophy (ODP 2nd & 3rd ed.)
- Macmillan Reference (Borchert)
- Philosophy Dictionary (Runes)
- Dictionary of Philosophical Terms (philosophypages.com)
- Indiana Philosophy Ontology (InPhO)

**Text Analysis:**
- `delta_analysis:*` - Delta-of-deltas convergence analysis
- `delta_phases:*` - Three-phase pipeline for text convergence
- `dictionary:clean:*` - Lexical data cleaning and normalization
- `units:*` - Dictionary unit normalization

**Utilities:**
- `names:*` - Philosopher name analysis and special character handling
- `knowledge:*` - Knowledge graph statistics
- `reference:*` - Reference work operations

See `docs/RAKE_TASKS.md` for detailed documentation of core tasks.

### Asset Pipeline & Bower Integration

The application uses Bower for frontend dependency management, integrated with the Rails asset pipeline.

**Bower Configuration:**
- `bower.json` → defines dependencies (d3, picnic, milligram, etc.)
- `.bowerrc` → configures installation to `vendor/assets/bower_components/`
- Run `bower install` to download packages

**Asset Pipeline Search Order:**
1. `app/assets/stylesheets` (application-specific styles)
2. `lib/assets/stylesheets` (local libraries)
3. `vendor/assets/stylesheets` (third-party & bower components)

**Key Workflow:**
```bash
# Add dependencies to bower.json
bower install

# Fix relative path issues in bower CSS (converts url() to asset_path helpers)
bin/rake resolve:paths

# Restart Rails server to pick up new assets
bin/rails server
```

**Integration Points:**
- `app/views/layouts/application.html.erb` → includes stylesheets via `stylesheet_link_tag`
- `app/assets/stylesheets/application.css` → manifest with `*= require` directives
- `vendor/assets/stylesheets/bower-sprockets.scss` → custom shim for complex components

See README.rdoc "Asset Pipeline & Bower Integration" for detailed documentation.

## Conclusion

CorpusBuilder is a powerful and feature-rich application for building and managing a corpus of philosophical texts. Its strengths are its rich data model, its powerful querying capabilities, and its integration with external data sources. However, its use of an outdated version of Rails and its complex database schema are significant considerations for any future development or maintenance.